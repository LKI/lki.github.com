<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.83.1" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Lirian Su" />
  <meta property="og:url" content="https://liriansu.com/posts/2017-12-09-jwt/" />
  <link rel="canonical" href="https://liriansu.com/posts/2017-12-09-jwt/" /><script type="application/ld+json">
  {
      "@context" : "https://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/liriansu.com\/"
      },
      "articleSection" : "posts",
      "name" : "一种简单的鉴权方式：JWT",
      "headline" : "一种简单的鉴权方式：JWT",
      "description" : "\u003cp\u003e这是一篇关于 \u003ca href=\u0022https:\/\/jwt.io\/\u0022\u003eJWT(JSON Web Token)\u003c\/a\u003e 的简短介绍。\u003c\/p\u003e",
      "inLanguage" : "en-US",
      "author" : "Lirian Su",
      "creator" : "Lirian Su",
      "publisher": "Lirian Su",
      "accountablePerson" : "Lirian Su",
      "copyrightHolder" : "Lirian Su",
      "copyrightYear" : "2017",
      "datePublished": "2017-12-09 20:07:17 \u002b0000 UTC",
      "dateModified" : "2017-12-09 20:07:17 \u002b0000 UTC",
      "url" : "https:\/\/liriansu.com\/posts\/2017-12-09-jwt\/",
      "keywords" : [  ]
  }
</script>
<title>一种简单的鉴权方式：JWT - 浮云计算</title>
  <meta property="og:title" content="一种简单的鉴权方式：JWT - 浮云计算" />
  <meta property="og:type" content="article" />
  <meta name="description" content="这是一篇关于 JWT(JSON Web Token) 的简短介绍。" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet"
    href="/css/github-markdown.min.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="浮云计算">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  

  
</head>


<body>
  <article class="post 中文" id="article">
    <div class="row">
      <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
        <div class="site-header">
          <header>
  <div class="signatures site-title">
    <a href="/">Lirian Su</a>
  </div>
</header>
<div class="row end-xs site-header-right">
  
  <div class="site-header-item">
    <a href="/about" target="_blank">about</a>
  </div>
  
  <div class="site-header-item">
    <a href="https://github.com/LKI" target="_blank">github</a>
  </div>
  
  <div class="site-header-item">
    <a href="https://www.zhihu.com/people/liriansu" target="_blank">zhihu</a>
  </div>
  
  <div class="site-header-item">
    <a href="/index.xml" target="_blank">rss</a>
  </div>
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">一种简单的鉴权方式：JWT</h1>
          
          <div class="row post-desc">
            
            <time class="post-header-item" datetime="2017-12-09 20:07:17 UTC">
              Written at 2017-12-09 20:07
            </time>
            
            <span class="post-header-item" id="busuanzi_container_page_pv"> Views <span id="busuanzi_value_page_pv" /> </span>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          <p>这是一篇关于 <a href="https://jwt.io/">JWT(JSON Web Token)</a> 的简短介绍。</p>

<h2 id="什么是jwt">什么是JWT</h2>

<p>JWT, 全称是JSON Web Token，<br />
是一种易于使用、无状态的鉴权(<a href="https://en.wikipedia.org/wiki/Authorization">Authorization</a>)方式。<br />
简单的来说，就是<br />
<strong>Server端把JSON数据经过加密做成token，以授权给Client端</strong>。</p>

<p>多说无益，上代码，举个栗子。</p>

<p>当Client端登录完成以后，<br />
Server端要返回一个7天有效的token，<br />
那么对应的Python的样例代码会是这样的：<br />
（<a href="https://github.com/jpadilla/pyjwt">使用了PyJWT包：<code>pip install pyjwt</code></a>）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time

<span style="color:#f92672">import</span> jwt

exp <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time()) <span style="color:#f92672">+</span> <span style="color:#ae81ff">86400</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>  <span style="color:#75715e"># 失效时间</span>
user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;liriansu&#39;</span>  <span style="color:#75715e"># 用户表示</span>
key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hunter2&#39;</span>  <span style="color:#75715e"># 密钥</span>
payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;exp&#39;</span>: exp, <span style="color:#e6db74">&#39;user&#39;</span>: user}  <span style="color:#75715e"># JSON 数据</span>
token <span style="color:#f92672">=</span> jwt<span style="color:#f92672">.</span>encode(payload, key)

<span style="color:#66d9ef">print</span>(token)
<span style="color:#75715e"># token可能会长这样子</span>
<span style="color:#75715e"># eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.EoKoMCjq_zGqUg5HDfqw4EN7EiG6gMjkUZle0uGJDGU</span></code></pre></div>
<blockquote>
<p><a href="/hunter2-meme">关于hunter2也有个梗：弱密码hunter2</a></p>
</blockquote>

<p>然后Client端每次在authorization header或者是query string里带上token。<br />
Server端收到请求的时候，<br />
用<code>payload = jwt.decode(token, key)</code>验证权限就行了。<br />
验证通过以后，payload中就是整个JSON数据。<br />
理论上你可以往token payload里塞任何_非敏感_数据。</p>

<p>所以综合来说，<br />
假如使用JWT作为鉴权方式，<br />
有以下几个特性：</p>

<ol>
<li>Client端不用管任何加密/解密，只用存token，在请求里面带上就行了。<br /></li>
<li>Server端可以实现不依赖外部存储鉴权，所有的数据都丢在token里。<br /></li>
<li>也就是说鉴权这一步不需要File/MySQL/Redis之类的数据库，也能知道用户身份。<br /></li>
<li>因为token带失效时间，所以需要在失效前/后再刷新token。<br />
<br /></li>
</ol>

<p>好了，以上就是关于JWT的所有描述了。<br />
本次的简单介绍就到此结束。（雾）<br />
（不过<a href="/hawk-authentication">上次关于Hawk的介绍</a>大概就是这样的）</p>

<h2 id="关于jwt的更多说明">关于JWT的更多说明</h2>

<blockquote>
<p>讲了这么多，实质上就是用个JSON数据当token，<br />
这破token真的安全吗？能伪造吗？</p>
</blockquote>

<p>emmmmmm, 好问题（表示这个问题很尖锐，难以正面回答，准备迂回）<br />
JWT使用很广泛，久经考验，大家都在用（表现了我也不懂，应该不会有问题吧？的一种从众心理）</p>

<p>认真地发表一下个人意见：<br />
首先token/key泄漏了，<br />
后果基本是跟其它鉴权方式一样严重。<br />
其次JWT可以选择合适的加密方式，<br />
加上合适的key是基本伪造不了的。<br />
还有就是在JWT之外，<br />
一定要用HTTPS！<br />
不用JWT相当于没有门禁，<br />
<a href="https://www.zhihu.com/question/52790301/answer/173452126">不用HTTPS基本是不穿内裤了</a>。。。</p>

<blockquote>
<p>我想了解更详细的JWT生成/验证过程</p>
</blockquote>

<p>具体说明请参照来源 <a href="https://tools.ietf.org/html/rfc7519">RFC7519 - JSON Web Token (JWT)</a></p>

<p>简单的来说，JWT是由以下三部分组成的：</p>

<ol>
<li>第一部分指定了加密算法(alg)和token类型(typ)。<br /></li>
<li>第二部分就是我们定义的payload。<br /></li>
<li>第三部分是由加密算法产生的签名。<br />
<br /></li>
</ol>

<p>获取了三部分数据以后，<br />
分别用base64加密，<br />
把最末的等号去掉，<br />
再用小数点连在一起，<br />
就是一个token了。<br />
验证的话，基本就是把这个过程反过来。</p>

<blockquote>
<p>我去，那token里的信息就是明文的啊？</p>
</blockquote>

<p>是的。<br />
所以token里不要带任何敏感信息。</p>

<p><a href="https://tools.ietf.org/html/rfc7519">文档上把payload里带的信息叫<code>Claim</code></a>，<br />
有这么几个可选的<code>Claim</code>：</p>

<ul>
<li><p><strong>iss</strong>: Issuer, 签发方。<br />
比如这个token是微信签发的，<br />
那么可以是<code>{'iss': 'wechat'}</code></p></li>

<li><p><strong>aud</strong>: Audience, 接收方。<br />
比如王者荣耀想用微信登录，<br />
那么可以是<code>{'aud': 'king-of-glory'}</code></p></li>

<li><p><strong>exp</strong>: Expiration Time, 失效时间。<br />
使用的是整形Unix时间戳，<br />
关于时间戳可以看看<a href="https://zhuanlan.zhihu.com/p/31829454">《互联网上的日期和时间》</a></p></li>
</ul>

<p><a href="https://tools.ietf.org/html/rfc7519">RFC7519</a>里面还有一点很好玩，<br />
就是上面每一个<code>Claim</code>最后都加了一句<code>Use of this claim is OPTIONAL</code><br />
（<a href="https://tools.ietf.org/html/rfc2119">RFC2119还定义过啥叫OPTIONAL</a>）</p>

<p>也就是说我们可以往payload里丢任何东西。<br />
只要符合这种加密/解密/鉴权的方式，<br />
我们都可以说“我们用了JWT”。</p>

<blockquote>
<p>那token会不会很大？</p>
</blockquote>

<p>有可能会。</p>

<p>所以payload里的东西能少则少，<br />
看文档里，连<code>issuer -&gt; iss</code>, <code>audience -&gt; aud</code>这种地方都给省了好几个字符。</p>

<p>还有就是传输JWT的时候，<br />
相较于放query string里，<br />
更推荐放在Request Headers里面。</p>

<h2 id="与其他鉴权方式的对比">与其他鉴权方式的对比</h2>

<p>详尽的比较超越了本文的范畴，<br />
<em>（写这句话好爽，可以少查一万个资料）</em><br />
下面就用个简单的表格来对比一下_我了解的_几种鉴权方式吧：<br />
<a href="https://tools.ietf.org/html/rfc7519">JWT</a>, <a href="https://tools.ietf.org/html/rfc6749">OAuth</a>, <a href="https://tools.ietf.org/html/rfc6265">Session</a>, <a href="/hawk-authentication">Hawk</a></p>

<p>| | JWT | OAuth | Session | Hawk |<br />
|-|&mdash;&ndash;|&mdash;&mdash;-|&mdash;&mdash;&mdash;|&mdash;&mdash;|<br />
| 易用性 | 容易，就一个token | 麻烦，要用Refresh Token刷Access Token | 容易，用Cookie就行 | 麻烦，每个请求都要单独计算header |<br />
| 泛用性 | 各种场合都适用 | 带三方授权的场合特别适用 | 还行吧&hellip; | 能用header的都适用 |<br />
| 安全性 | 跟别的方案差不多，key泄漏了就完蛋了 | Auth Server安全就行，<del>我才不管Client</del>其它的跟别的方案差不多 | 还行吧&hellip; | <a href="/hawk-authentication">我！能！防！中间人攻击！</a> |<br />
| 接受度 | 有一定安全度，client端很喜欢，用的还是很多的 | 繁琐和安全的折中方案，很多大厂都用 | 真的广&hellip; | 目前只听说了我司在用Hawk |</p>

<h2 id="其它感受">其它感受</h2>

<ul>
<li><p>JWT全称叫JSON Web Token,<br />
小心别写了类似<code>jwt_token</code>这样的变量名了（语义重复）。</p></li>

<li><p><a href="https://tools.ietf.org/html/rfc7519">RFC7519还定义了JWT读起来是类似于jot的发音</a>。<br />
然而实际中交流都会说JWT（怕听不懂）。</p></li>

<li><p>JWT说是说用同一个key就行了，<br />
不过我们在项目实际中还是根据不一样的user用了不一样的key。<br />
（同时也用了数据库）</p></li>

<li><p>假如payload里带了失效时间，<br />
理论上JWT签发后是不会失效的，<br />
也就是Server端管理不了这些token。<br />
（所以可以加个数据库来管）<br />
（好像变复杂了）</p></li>

<li><p>用JWT想做“记住登录状态”这个功能的话，<br />
可以设定token失效期比如是7天，<br />
然后用户每天登录的时候刷一次token。<br />
这样除非用户一周内都没登录，<br />
才会请求重新登录。</p></li>

<li><p>我对互联网安全的认知是真的有限，<br />
经常看文档，<br />
一句话学到三四个新的词。<br />
还是要多学习一个啊。<br />
所谓<code>苟日新，日日新，又日新</code>是也。</p></li>
</ul>
        </div>

        
          

          
          <div style="height: 20px;"></div>
        

        



<div class="post-comments">
  <script src="https://utteranc.es/client.js"
          repo="LKI/lki.github.io"
          issue-term="title"
          label="comment"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>
</div>


        

<div class="site-footer">
  <div class="site-footer-left">
    <div class="site-footer-item">
      <span id="busuanzi_container_site_pv" style="display:none"> PV: <span id="busuanzi_value_site_pv"/> </span>
    </div>
    <div class="site-footer-item">
      <span id="busuanzi_container_site_uv" style="display:none"> UV: <span id="busuanzi_value_site_uv"/> </span>
    </div>
  </div>

  <div class="site-footer-right">
    
    
    <div class="site-footer-item">
      <a href="/en/">English</a>
    </div>
    
    
  </div>
</div>

      </div>
    </div>
  </article>

  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

</body>

</html>
